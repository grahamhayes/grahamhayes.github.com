<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns#
article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Setting up a wireguard VPN instance on my UniFi Security Gateway">
<meta name="viewport" content="width=device-width">
<title>WireGuard + UniFi | graham.hayes.ie</title>
<link href="../../assets/css/bitter.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/main.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/code.css" rel="stylesheet" type="text/css">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="http://graham.hayes.ie/posts/wireguard-%2B-unifi/">
<!--[if lt IE 9]><script src="/assets/js/html5.js"></script><![endif]--><meta name="author" content="Graham Hayes">
<meta property="og:site_name" content="graham.hayes.ie">
<meta property="og:title" content="WireGuard + UniFi">
<meta property="og:url" content="http://graham.hayes.ie/posts/wireguard-%2B-unifi/">
<meta property="og:description" content="Setting up a wireguard VPN instance on my UniFi Security Gateway">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2019-02-07T19:09:26Z">
<meta property="article:tag" content="networking">
<meta property="article:tag" content="unifi">
<meta property="article:tag" content="vpn">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@grahamhayes">
<meta name="twitter:creator" content="@grahamhayes">
<meta name="twitter:image" content="http://graham.hayes.ie/images/me.jpg">
</head>
<body>
    <section class="social"><ul>
<a href="../../"><img style="border-radius: 50%; margin-left: auto; margin-right: auto; display: block; margin-bottom: 20px" width="80" height="80" src="../../images/me.jpg"></a>
                    <li><a href="../../" title="Home"><i class="icon-home"></i></a></li>
            <li><a href="../../archive.html" title="Archives"><i class="icon-folder-open-alt"></i></a></li>
            <li><a href="../../categories" title="Tags"><i class="icon-tags"></i></a></li>
            <li><a href="../../projects" title="Projects"><i class="icon-briefcase"></i></a></li>
            <li><a href="../../stories/about-me" title="About Me"><i class="icon-info"></i></a></li>
            <li><a href="../../rss.xml" title="RSS"><i class="icon-rss"></i></a></li>
            <li><a href="https://twitter.com/grahamhayes" title="My Twitter"><i class="icon-twitter"></i></a></li>
            <li><a href="https://github.com/grahamhayes" title="My Github"><i class="icon-github"></i></a></li>

        </ul></section><section class="page-content"><div class="content" rel="main">
    <div class="post">
        <h1 class="p-name entry-title" itemprop="headline name">WireGuard + UniFi</h1>

        <div class="meta">
            <div class="authordate">
                <time class="timeago" datetime="2019-02-07T19:09:26+00:00">2019-02-07 19:09</time>
            
                      |  
        <a href="../wireguard-%2B-unifi/index.rst" id="sourcelink">Source</a>

            </div>
                    <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="../../categories/networking/" rel="tag">networking</a></li>
           <li><a class="tag p-category" href="../../categories/unifi/" rel="tag">unifi</a></li>
           <li><a class="tag p-category" href="../../categories/vpn/" rel="tag">vpn</a></li>
        </ul>
</div>

        </div>
        <div class="body">
            <div>
<p>I have been looking around for a good VPN solution to use on the road recently. I have a few
services running at home, that I really don't want on the internet (OctoPrint etc), but I want to use
remotely.</p>
<p>This is as much documentation for future me as it is for anyone who stumbles across this page :)</p>
<p>I had previously set up a L2TP Remote user VPN in the UniFi controller, but it had a few issues.</p>
<ul class="simple">
<li>Roaming problems on mobile</li>
<li>Battery usage on mobile</li>
<li>Slow Speeds</li>
</ul>
<p>I had heard of Wireguard a while ago (I think they had a stall near the OpenStack stall in FOSDEM
last year), but I had completely forgotten about them. It turns out some kind soul has created a
deb package to install WireGuard on Vyatta (which is what the USG is based on).</p>
<div class="section" id="installation">
<h2>Installation</h2>
<ul class="simple">
<li>Pick up the correct .deb from <a class="reference external" href="https://github.com/Lochnair/vyatta-wireguard/releases">here</a><ul>
<li>
<code class="bash">curl -sL https://github.com/Lochnair/vyatta-wireguard/releases/download/&lt;version&gt;/wireguard-&lt;board&gt;-&lt;version&gt;.deb -o wireguard-&lt;board&gt;-&lt;version&gt;.deb</code> worked for me</li>
<li>In my case, version was <tt class="docutils literal"><span class="pre">0.0.20190123-1</span></tt> and board was <tt class="docutils literal">ugw3</tt>
</li>
</ul>
</li>
<li>
<code class="bash">sudo dpkg -i wireguard-&lt;board&gt;-&lt;version&gt;-1.deb</code> to install the package</li>
<li>
<code class="bash">sudo -i</code> to make everything easier</li>
<li>
<code class="bash"><span class="nb">umask</span> <span class="m">077</span> <span class="o">&amp;&amp;</span> mkdir wireguard <span class="o">&amp;&amp;</span> <span class="nb">cd</span> wireguard</code> for the server keys</li>
<li>
<code class="bash">wg genkey <span class="p">|</span> tee wg_private.key <span class="p">|</span> wg pubkey &gt; wg_public.key</code> to create server keys</li>
<li>
<code class="bash">wg genkey <span class="p">|</span> tee client1_private.key <span class="p">|</span> wg pubkey &gt; client1_public.key</code> to create the first client keys. You will need one of these keys for each client connecting to the VPN</li>
<li>Then we move over to the UniFi controller to create the config for the VPN</li>
</ul>
</div>
<div class="section" id="config-gateway-json">
<h2>config.gateway.json</h2>
<p>UniFi gateways are pretty similar to EdgeRouter products from Ubiquiti, with a crucial difference. Any config changes done from the CLI are wiped out on
reboots, or any config changes from the controller. the UniFi Controller is nice, but does not support the full range of EdgeOS features that we can use.</p>
<p>Thankfully there is a solution - <tt class="docutils literal">config.gateway.json</tt>. This file is layered over the base config that gets generated by UniFi, and allows much more control of a USG.</p>
<p>I created this file in my UniFi controller (for me, on Ubuntu the right location is <tt class="docutils literal"><span class="pre">/usr/lib/unifi/data/sites/&lt;site-id&gt;/config.gateway.json</span></tt>).</p>
<pre class="code json"><a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-1"></a><span class="p">{</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-2"></a>    <span class="nt">"firewall"</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-3"></a>        <span class="nt">"group"</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-4"></a>            <span class="nt">"network-group"</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-5"></a>                <span class="nt">"remote_user_vpn_network"</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-6"></a>                    <span class="nt">"description"</span><span class="p">:</span> <span class="s2">"Remote User VPN subnets"</span><span class="p">,</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-7"></a>                    <span class="nt">"network"</span><span class="p">:</span> <span class="p">[</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-8"></a>                        <span class="s2">"10.255.252.0/24"</span><span class="p">,</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-9"></a>                    <span class="p">]</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-10"></a>                <span class="p">}</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-11"></a>            <span class="p">}</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-12"></a>        <span class="p">}</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-13"></a>    <span class="p">},</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-14"></a>    <span class="nt">"interfaces"</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-15"></a>        <span class="nt">"wireguard"</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-16"></a>            <span class="nt">"wg0"</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-17"></a>                <span class="nt">"description"</span><span class="p">:</span> <span class="s2">"VPN for remote clients"</span><span class="p">,</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-18"></a>                <span class="nt">"address"</span><span class="p">:</span> <span class="p">[</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-19"></a>                    <span class="s2">"10.255.252.1/24"</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-20"></a>                <span class="p">],</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-21"></a>                <span class="nt">"firewall"</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-22"></a>                    <span class="nt">"in"</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-23"></a>                        <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"LAN_IN"</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-24"></a>                    <span class="p">},</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-25"></a>                    <span class="nt">"local"</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-26"></a>                        <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"LAN_LOCAL"</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-27"></a>                    <span class="p">},</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-28"></a>                    <span class="nt">"out"</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-29"></a>                        <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"LAN_OUT"</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-30"></a>                    <span class="p">}</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-31"></a>                <span class="p">},</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-32"></a>                <span class="nt">"listen-port"</span><span class="p">:</span> <span class="s2">"443"</span><span class="p">,</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-33"></a>                <span class="nt">"mtu"</span><span class="p">:</span> <span class="s2">"1352"</span><span class="p">,</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-34"></a>                <span class="nt">"peer"</span><span class="p">:</span> <span class="p">[</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-35"></a>                    <span class="p">{</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-36"></a>                        <span class="nt">"&lt;content of client1_public.key&gt;"</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-37"></a>                            <span class="nt">"allowed-ips"</span><span class="p">:</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-38"></a>                            <span class="p">[</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-39"></a>                                <span class="s2">"10.255.252.2/32"</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-40"></a>                            <span class="p">],</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-41"></a>                            <span class="nt">"persistent-keepalive"</span><span class="p">:</span> <span class="mi">60</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-42"></a>                        <span class="p">}</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-43"></a>                    <span class="p">}</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-44"></a>                <span class="p">],</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-45"></a>                <span class="nt">"private-key"</span><span class="p">:</span> <span class="s2">"/config/auth/wireguard/wg_private.key"</span><span class="p">,</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-46"></a>                <span class="nt">"route-allowed-ips"</span><span class="p">:</span> <span class="s2">"true"</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-47"></a>            <span class="p">}</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-48"></a>        <span class="p">}</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-49"></a>    <span class="p">}</span>
<a name="rest_code_e8ff670c928449a2ab3ea39b440a9522-50"></a><span class="p">}</span>
</pre>
</div>
</div>
        </div>
                <ul class="pager hidden-print">
<li class="previous">
                <a href="../openstack-tc-nomination-rocky/" rel="prev" title="TC Nomination - Rocky Cycle">Previous post</a>
            </li>
            <li class="next">
                <a href="../new-open-infrastructure-projects/" rel="next" title="New Open Infrastructure Project(s)">Next post</a>
            </li>
        </ul>
<div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="grahamhayesie",
            disqus_url="http://graham.hayes.ie/posts/wireguard-%2B-unifi/",
        disqus_title="WireGuard + UniFi",
        disqus_identifier="cache/posts/wireguard-+-unifi.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


            

    </div>
                    <footer id="footer"><p>Contents © 2019         <a href="mailto:graham@hayes.ie">Graham Hayes</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         </p>
            
        </footer>
</div>
    </section><script src="../../assets/js/jquery-1.10.2.min.js" type="text/javascript"></script><script src="../../assets/js/jquery.timeago.js" type="text/javascript"></script><script type="text/javascript">
            $(function(){
                $('.timeago').timeago();
            });
        </script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-23042579-7', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
