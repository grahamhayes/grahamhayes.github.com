<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns#
article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Setting up a wireguard VPN instance on my UniFi Security Gateway">
<meta name="viewport" content="width=device-width">
<title>WireGuard + UniFi | graham.hayes.ie</title>
<link href="../../assets/css/bitter.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/main.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/code.css" rel="stylesheet" type="text/css">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="http://graham.hayes.ie/posts/wireguard-%2B-unifi/">
<!--[if lt IE 9]><script src="/assets/js/html5.js"></script><![endif]--><meta name="author" content="Graham Hayes">
<meta property="og:site_name" content="graham.hayes.ie">
<meta property="og:title" content="WireGuard + UniFi">
<meta property="og:url" content="http://graham.hayes.ie/posts/wireguard-%2B-unifi/">
<meta property="og:description" content="Setting up a wireguard VPN instance on my UniFi Security Gateway">
<meta property="og:image" content="http://graham.hayes.ie/wireguard-logo.png">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2019-02-07T22:52:26Z">
<meta property="article:tag" content="networking">
<meta property="article:tag" content="unifi">
<meta property="article:tag" content="vpn">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@grahamhayes">
<meta name="twitter:creator" content="@grahamhayes">
<meta name="twitter:image" content="../../wireguard-logo.png">
</head>
<body>
    <section class="social"><ul>
<a href="../../"><img style="border-radius: 50%; margin-left: auto; margin-right: auto; display: block; margin-bottom: 20px" width="80" height="80" src="../../images/me.jpg"></a>
                    <li><a href="../../" title="Home"><i class="icon-home"></i></a></li>
            <li><a href="../../archive.html" title="Archives"><i class="icon-folder-open-alt"></i></a></li>
            <li><a href="../../categories" title="Tags"><i class="icon-tags"></i></a></li>
            <li><a href="../../projects" title="Projects"><i class="icon-briefcase"></i></a></li>
            <li><a href="../../stories/about-me" title="About Me"><i class="icon-info"></i></a></li>
            <li><a href="../../rss.xml" title="RSS"><i class="icon-rss"></i></a></li>
            <li><a href="https://twitter.com/grahamhayes" title="My Twitter"><i class="icon-twitter"></i></a></li>
            <li><a href="https://github.com/grahamhayes" title="My Github"><i class="icon-github"></i></a></li>

        </ul></section><section class="page-content"><div class="content" rel="main">
    <div class="post">
        <h1 class="p-name entry-title" itemprop="headline name">WireGuard + UniFi</h1>

        <div class="meta">
            <div class="authordate">
                <time class="timeago" datetime="2019-02-07T22:52:26+00:00">2019-02-07 22:52</time>
            
                      |  
        <a href="../wireguard-%2B-unifi/index.rst" id="sourcelink">Source</a>

            </div>
                    <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="../../categories/networking/" rel="tag">networking</a></li>
           <li><a class="tag p-category" href="../../categories/unifi/" rel="tag">unifi</a></li>
           <li><a class="tag p-category" href="../../categories/vpn/" rel="tag">vpn</a></li>
        </ul>
</div>

        </div>
        <div class="body">
            <div>
<p>I have been looking around for a good VPN solution to use on the road recently. I have a few
services running at home, that I really don't want on the internet (OctoPrint etc), but I want to use
remotely.</p>
<p>This is as much documentation for future me as it is for anyone who stumbles across this page :)</p>
<p>I had previously set up a L2TP Remote user VPN in the UniFi controller, but it had a few issues.</p>
<ul class="simple">
<li>Roaming problems on mobile</li>
<li>Battery usage on mobile</li>
<li>Slow Speeds</li>
</ul>
<p>I had heard of Wireguard a while ago (I think they had a stall near the OpenStack stall in FOSDEM
last year), but I had completely forgotten about them. It turns out some kind soul has created a
deb package to install WireGuard on Vyatta (which is what the USG is based on).</p>
<!-- TEASER_END -->
<div class="section" id="installation">
<h2>Installation</h2>
<ul class="simple">
<li>Pick up the correct .deb from <a class="reference external" href="https://github.com/Lochnair/vyatta-wireguard/releases">here</a><ul>
<li>
<code class="bash">curl -sL https://github.com/Lochnair/vyatta-wireguard/releases/download/&lt;version&gt;/wireguard-&lt;board&gt;-&lt;version&gt;.deb -o wireguard-&lt;board&gt;-&lt;version&gt;.deb</code> worked for me</li>
<li>In my case, version was <tt class="docutils literal"><span class="pre">0.0.20190123-1</span></tt> and board was <tt class="docutils literal">ugw3</tt>
</li>
</ul>
</li>
<li>
<code class="bash">sudo dpkg -i wireguard-&lt;board&gt;-&lt;version&gt;-1.deb</code> to install the package</li>
<li>
<code class="bash">sudo -i</code> to make everything easier</li>
<li>
<code class="bash"><span class="nb">umask</span> <span class="m">077</span> <span class="o">&amp;&amp;</span> mkdir wireguard <span class="o">&amp;&amp;</span> <span class="nb">cd</span> wireguard</code> for the server keys</li>
<li>
<code class="bash">wg genkey <span class="p">|</span> tee wg_private.key <span class="p">|</span> wg pubkey &gt; wg_public.key</code> to create server keys</li>
<li>
<code class="bash">wg genkey <span class="p">|</span> tee client1_private.key <span class="p">|</span> wg pubkey &gt; client1_public.key</code> to create the first client keys. You will need one of these keys for each client connecting to the VPN</li>
<li>Then we move over to the UniFi controller to create the config for the VPN</li>
</ul>
</div>
<div class="section" id="config-gateway-json">
<h2>config.gateway.json</h2>
<p>UniFi gateways are pretty similar to EdgeRouter products from Ubiquiti, with a crucial difference. Any config changes done from the CLI are wiped out on
reboots, or any config changes from the controller. the UniFi Controller is nice, but does not support the full range of EdgeOS features that we can use.</p>
<p>Thankfully there is a solution - <tt class="docutils literal">config.gateway.json</tt>. This file is layered over the base config that gets generated by UniFi, and allows much more control of a USG.</p>
<p>I created this file in my UniFi controller (for me, on Ubuntu the right location is <tt class="docutils literal"><span class="pre">/usr/lib/unifi/data/sites/&lt;site-id&gt;/config.gateway.json</span></tt>).</p>
<pre class="code json"><a name="rest_code_c23525c262874207837621b3f535252a-1"></a><span class="p">{</span>
<a name="rest_code_c23525c262874207837621b3f535252a-2"></a>    <span class="nt">"firewall"</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_c23525c262874207837621b3f535252a-3"></a>        <span class="nt">"group"</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_c23525c262874207837621b3f535252a-4"></a>            <span class="nt">"network-group"</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_c23525c262874207837621b3f535252a-5"></a>                <span class="nt">"remote_user_vpn_network"</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_c23525c262874207837621b3f535252a-6"></a>                    <span class="nt">"description"</span><span class="p">:</span> <span class="s2">"Remote User VPN subnets"</span><span class="p">,</span>
<a name="rest_code_c23525c262874207837621b3f535252a-7"></a>                    <span class="nt">"network"</span><span class="p">:</span> <span class="p">[</span>
<a name="rest_code_c23525c262874207837621b3f535252a-8"></a>                        <span class="s2">"10.255.252.0/24"</span><span class="p">,</span>
<a name="rest_code_c23525c262874207837621b3f535252a-9"></a>                    <span class="p">]</span>
<a name="rest_code_c23525c262874207837621b3f535252a-10"></a>                <span class="p">}</span>
<a name="rest_code_c23525c262874207837621b3f535252a-11"></a>            <span class="p">}</span>
<a name="rest_code_c23525c262874207837621b3f535252a-12"></a>        <span class="p">}</span>
<a name="rest_code_c23525c262874207837621b3f535252a-13"></a>    <span class="p">},</span>
<a name="rest_code_c23525c262874207837621b3f535252a-14"></a>    <span class="nt">"interfaces"</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_c23525c262874207837621b3f535252a-15"></a>        <span class="nt">"wireguard"</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_c23525c262874207837621b3f535252a-16"></a>            <span class="nt">"wg0"</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_c23525c262874207837621b3f535252a-17"></a>                <span class="nt">"description"</span><span class="p">:</span> <span class="s2">"VPN for remote clients"</span><span class="p">,</span>
<a name="rest_code_c23525c262874207837621b3f535252a-18"></a>                <span class="nt">"address"</span><span class="p">:</span> <span class="p">[</span>
<a name="rest_code_c23525c262874207837621b3f535252a-19"></a>                    <span class="s2">"10.255.252.1/24"</span>
<a name="rest_code_c23525c262874207837621b3f535252a-20"></a>                <span class="p">],</span>
<a name="rest_code_c23525c262874207837621b3f535252a-21"></a>                <span class="nt">"firewall"</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_c23525c262874207837621b3f535252a-22"></a>                    <span class="nt">"in"</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_c23525c262874207837621b3f535252a-23"></a>                        <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"LAN_IN"</span>
<a name="rest_code_c23525c262874207837621b3f535252a-24"></a>                    <span class="p">},</span>
<a name="rest_code_c23525c262874207837621b3f535252a-25"></a>                    <span class="nt">"local"</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_c23525c262874207837621b3f535252a-26"></a>                        <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"LAN_LOCAL"</span>
<a name="rest_code_c23525c262874207837621b3f535252a-27"></a>                    <span class="p">},</span>
<a name="rest_code_c23525c262874207837621b3f535252a-28"></a>                    <span class="nt">"out"</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_c23525c262874207837621b3f535252a-29"></a>                        <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"LAN_OUT"</span>
<a name="rest_code_c23525c262874207837621b3f535252a-30"></a>                    <span class="p">}</span>
<a name="rest_code_c23525c262874207837621b3f535252a-31"></a>                <span class="p">},</span>
<a name="rest_code_c23525c262874207837621b3f535252a-32"></a>                <span class="nt">"listen-port"</span><span class="p">:</span> <span class="s2">"443"</span><span class="p">,</span>
<a name="rest_code_c23525c262874207837621b3f535252a-33"></a>                <span class="nt">"mtu"</span><span class="p">:</span> <span class="s2">"1352"</span><span class="p">,</span>
<a name="rest_code_c23525c262874207837621b3f535252a-34"></a>                <span class="nt">"peer"</span><span class="p">:</span> <span class="p">[</span>
<a name="rest_code_c23525c262874207837621b3f535252a-35"></a>                    <span class="p">{</span>
<a name="rest_code_c23525c262874207837621b3f535252a-36"></a>                        <span class="nt">"&lt;content of client1_public.key&gt;"</span><span class="p">:</span> <span class="p">{</span>
<a name="rest_code_c23525c262874207837621b3f535252a-37"></a>                            <span class="nt">"allowed-ips"</span><span class="p">:</span>
<a name="rest_code_c23525c262874207837621b3f535252a-38"></a>                            <span class="p">[</span>
<a name="rest_code_c23525c262874207837621b3f535252a-39"></a>                                <span class="s2">"10.255.252.2/32"</span>
<a name="rest_code_c23525c262874207837621b3f535252a-40"></a>                            <span class="p">],</span>
<a name="rest_code_c23525c262874207837621b3f535252a-41"></a>                            <span class="nt">"persistent-keepalive"</span><span class="p">:</span> <span class="mi">60</span>
<a name="rest_code_c23525c262874207837621b3f535252a-42"></a>                        <span class="p">}</span>
<a name="rest_code_c23525c262874207837621b3f535252a-43"></a>                    <span class="p">}</span>
<a name="rest_code_c23525c262874207837621b3f535252a-44"></a>                <span class="p">],</span>
<a name="rest_code_c23525c262874207837621b3f535252a-45"></a>                <span class="nt">"private-key"</span><span class="p">:</span> <span class="s2">"/config/auth/wireguard/wg_private.key"</span><span class="p">,</span>
<a name="rest_code_c23525c262874207837621b3f535252a-46"></a>                <span class="nt">"route-allowed-ips"</span><span class="p">:</span> <span class="s2">"true"</span>
<a name="rest_code_c23525c262874207837621b3f535252a-47"></a>            <span class="p">}</span>
<a name="rest_code_c23525c262874207837621b3f535252a-48"></a>        <span class="p">}</span>
<a name="rest_code_c23525c262874207837621b3f535252a-49"></a>    <span class="p">}</span>
<a name="rest_code_c23525c262874207837621b3f535252a-50"></a><span class="p">}</span>
</pre>
</div>
<div class="section" id="client-configs">
<h2>Client Configs</h2>
<p>Next up - lets add some client configs. First device I wanted to add (as I was
at home, and wanted to make sure this worked from outside the network, and is
the main device I seem to want remote access from) is my Android phone.</p>
<p>So, I created the following config:</p>
<pre class="code ini"><a name="rest_code_73b8e270f4af4dea982b5e0672091f33-1"></a><span class="k">[Interface]</span>
<a name="rest_code_73b8e270f4af4dea982b5e0672091f33-2"></a><span class="na">PrivateKey</span> <span class="o">=</span> <span class="s">&lt;content of client1_private.key&gt;</span>
<a name="rest_code_73b8e270f4af4dea982b5e0672091f33-3"></a><span class="na">Address</span> <span class="o">=</span> <span class="s">10.255.252.2/24</span>
<a name="rest_code_73b8e270f4af4dea982b5e0672091f33-4"></a><span class="na">DNS</span> <span class="o">=</span> <span class="s">&lt;internal DNS Server&gt;</span>
<a name="rest_code_73b8e270f4af4dea982b5e0672091f33-5"></a>
<a name="rest_code_73b8e270f4af4dea982b5e0672091f33-6"></a><span class="k">[Peer]</span>
<a name="rest_code_73b8e270f4af4dea982b5e0672091f33-7"></a><span class="na">PublicKey</span> <span class="o">=</span> <span class="s">&lt;content of wg_public.key&gt;</span>
<a name="rest_code_73b8e270f4af4dea982b5e0672091f33-8"></a><span class="na">Endpoint</span> <span class="o">=</span> <span class="s">&lt;external-fqdn&gt;:443</span>
<a name="rest_code_73b8e270f4af4dea982b5e0672091f33-9"></a><span class="na">AllowedIPs</span> <span class="o">=</span> <span class="s">&lt;local subnets&gt;, 10.255.252.0/24</span>
</pre>
<p>Then <code class="bash">qrencode -t ansiutf8 &lt; wireguard.conf</code> printed a qrcode on my console
that I could import the config into the Android <a class="reference external" href="https://play.google.com/store/apps/details?id=com.wireguard.android">app</a></p>
<p>For my laptop, it is pretty easy as well, simply <code class="bash">brew install wireguard-tools</code>
and then create a similar file. We have to re run the <code class="bash">wg genkey <span class="p">|</span> tee client1_private.key <span class="p">|</span> wg pubkey &gt; client1_public.key</code>
and add an extra peer to the <tt class="docutils literal">config.gateway.json</tt> file, for each new client, but that is all the config we need.</p>
</div>
<div class="section" id="starting-it-all-up">
<h2>Starting it all up</h2>
<p>You will also have to allow udp/443 to pass through the firewall. I created a
rule in the GUI that allows udp/443 on the WAN_LOCAL group.</p>
<p>Now, to force the provisioning for the USG, just go to your unifi controller, then find the
device. In the settings (the cog icon) for the device find the following section:</p>
<img alt="../../images/usg-provision.png" src="../../images/usg-provision.png"><p>and trigger a force provision.</p>
<p>Then when it is deployed, you can start the tunnel on your end device!</p>
<p>To check if the wireguard service is actually listening, you can run netstat and
see if there is anything listening on udp/443</p>
<pre class="code console"><a name="rest_code_86396b2a3d534cdd9c5040128fbad9f4-1"></a><span class="gp">root@edge:~#</span> netstat -npl <span class="p">|</span> grep <span class="m">443</span> <span class="p">|</span> grep udp
<a name="rest_code_86396b2a3d534cdd9c5040128fbad9f4-2"></a><span class="go">udp        0      0 0.0.0.0:443             0.0.0.0:*                           -</span>
<a name="rest_code_86396b2a3d534cdd9c5040128fbad9f4-3"></a><span class="go">udp6       0      0 :::443                  :::*                                -</span>
</pre>
<p>You should see the following on the android settings pull down:</p>
<img alt="../../images/android-wireguard.png" src="../../images/android-wireguard.png"><p>and on the USG, you can see the far side of the tunnel:</p>
<pre class="code console"><a name="rest_code_5d6cb98b4f144ca2a54546c810215e87-1"></a><span class="gp">root@edge:~#</span> show interfaces wireguard wg0 endpoints
<a name="rest_code_5d6cb98b4f144ca2a54546c810215e87-2"></a><span class="go">&lt;content-of-client1_public.key file&gt;    212.129.73.196:50453</span>
</pre>
<p>On OSX, make sure the config file is named like an interface (wg0.conf etc), and run
<code class="bash">wg-quick up &lt;path/to/config/file&gt;</code> - and you will be connected.</p>
<div class="section" id="footnotes-thanks">
<h3>Footnotes + Thanks</h3>
<p>I did not figure any of this out myself - <a class="reference external" href="https://community.ubnt.com/t5/user/viewprofilepage/user-id/647439">mbello</a> filled in most of it from
his post on the <a class="reference external" href="https://community.ubnt.com/t5/UniFi-Routing-Switching/WireGuard-VPN-server-setup-on-USG/m-p/2573407/highlight/true#M118707">UniFi Forums</a></p>
<p>The OSX tooling was from a post called <a class="reference external" href="https://medium.com/@headquartershq/setting-up-wireguard-on-a-mac-8a121bfe9d86">Cheatsheet for setting up a WireGuard client on a Mac</a></p>
<p>This has been up for a day or so, and the roaming on mobile has been great. Even
when I walk into the house, and connect to the home network, the overhead is
so small, I don't notice any issues.</p>
<p>If I hit any issues, I will update this page with more details.</p>
<p>Happy VPNing!</p>
</div>
</div>
</div>
        </div>
                <ul class="pager hidden-print">
<li class="previous">
                <a href="../openstack-tc-nomination-rocky/" rel="prev" title="TC Nomination - Rocky Cycle">Previous post</a>
            </li>
        </ul>
<div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="grahamhayesie",
            disqus_url="http://graham.hayes.ie/posts/wireguard-%2B-unifi/",
        disqus_title="WireGuard + UniFi",
        disqus_identifier="cache/posts/wireguard-+-unifi.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


            

    </div>
                    <footer id="footer"><p>Contents © 2019         <a href="mailto:graham@hayes.ie">Graham Hayes</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         </p>
            
        </footer>
</div>
    </section><script src="../../assets/js/jquery-1.10.2.min.js" type="text/javascript"></script><script src="../../assets/js/jquery.timeago.js" type="text/javascript"></script><script type="text/javascript">
            $(function(){
                $('.timeago').timeago();
            });
        </script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-23042579-7', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
