<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns#
article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Tracking down TCP send errors.">
<meta name="viewport" content="width=device-width">
<title>MiniDNS, TCP, and the internet | graham.hayes.ie</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="http://graham.hayes.ie/posts/minidns-tcp-and-the-internet/">
<!--[if lt IE 9]><script src="/assets/js/html5.js"></script><![endif]--><meta name="author" content="Graham Hayes">
<meta property="og:site_name" content="graham.hayes.ie">
<meta property="og:title" content="MiniDNS, TCP, and the internet">
<meta property="og:url" content="http://graham.hayes.ie/posts/minidns-tcp-and-the-internet/">
<meta property="og:description" content="Tracking down TCP send errors.">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2016-03-04T20:50:00Z">
<meta property="article:tag" content="bugs">
<meta property="article:tag" content="eventlet">
<meta property="article:tag" content="networking">
<meta property="article:tag" content="openstack">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@grahamhayes">
<meta name="twitter:creator" content="@grahamhayes">
<meta name="twitter:image" content="http://graham.hayes.ie/images/me.jpg">
</head>
<body>
    <section class="social"><ul>
<a href="../../"><img style="border-radius: 50%; margin-left: auto; margin-right: auto; display: block; margin-bottom: 20px" width="80" height="80" src="../../images/me.jpg"></a>
                    <li><a href="../../" title="Home"><i class="icon-home"></i></a></li>
            <li><a href="../../archive.html" title="Archives"><i class="icon-folder-open-alt"></i></a></li>
            <li><a href="../../categories" title="Tags"><i class="icon-tags"></i></a></li>
            <li><a href="../../projects" title="Projects"><i class="icon-briefcase"></i></a></li>
            <li><a href="../../stories/about-me" title="About Me"><i class="icon-info"></i></a></li>
            <li><a href="../../rss.xml" title="RSS"><i class="icon-rss"></i></a></li>
            <li><a href="https://twitter.com/grahamhayes" title="My Twitter"><i class="icon-twitter"></i></a></li>
            <li><a href="https://github.com/grahamhayes" title="My Github"><i class="icon-github"></i></a></li>

        </ul></section><section class="page-content"><div class="content" rel="main">
    <div class="post">
        <h1 class="p-name entry-title" itemprop="headline name">MiniDNS, TCP, and the internet</h1>

        <div class="meta">
            <div class="authordate">
                <time class="timeago" datetime="2016-03-04T20:50:00+00:00">2016-03-04 20:50</time>
            
                      |  
        <a href="index.rst" id="sourcelink">Source</a>

            </div>
                    <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="../../categories/bugs/" rel="tag">bugs</a></li>
           <li><a class="tag p-category" href="../../categories/eventlet/" rel="tag">eventlet</a></li>
           <li><a class="tag p-category" href="../../categories/networking/" rel="tag">networking</a></li>
           <li><a class="tag p-category" href="../../categories/openstack/" rel="tag">openstack</a></li>
        </ul>
</div>

        </div>
        <div class="body">
            <div>
<p>We had <a class="reference external" href="https://bugs.launchpad.net/designate/+bug/1552864">this bug</a> come
in yesterday.</p>
<p>It was a bit unexpected - as we tested it pretty extensively when it was being
developed.</p>
<p>The line in question was this:</p>
<pre class="code python"><a name="rest_code_c65485f2567941cc885a40b0501e2e0a-1"></a><span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">tcp_response</span><span class="p">)</span>
</pre>
<p>In eventlet 0.17.x this behaved like the standard
<code class="python"><span class="n">socket</span><span class="o">.</span><span class="n">sendall</span><span class="p">()</span></code> , instead of <code class="python"><span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">()</span></code></p>
<p>(It was <a class="reference external" href="https://github.com/eventlet/eventlet/commit/c315ee86dac996ac533b738f7c8777f4d01a0472">this commit</a> as it turns out - it was noted in the release notes <a class="reference external" href="http://eventlet.net/doc/changelog.html#id5">here</a> but we missed it)</p>
<p>The other major problem is that the bug did not manifest itself until we pushed
the AXFR over a long range connection.</p>
<!-- TEASER_END -->
<p>To test it, I booted a VM in West US (California I believe), installed designate
and populated a DB with a large zone using</p>
<p><a class="reference external" href="../../listings/generate-zone-rrsets.sh.html">generate-zone-rrsets.sh</a></p>
<pre class="code bash"><a name="rest_code_e72fa307033546b19fef595b6c58376c-1"></a>    <span class="c1">#!/bin/bash</span>
<a name="rest_code_e72fa307033546b19fef595b6c58376c-2"></a>    <span class="k">for</span> i in <span class="k">$(</span>seq <span class="m">1</span> 2000<span class="k">)</span><span class="p">;</span> <span class="k">do</span>
<a name="rest_code_e72fa307033546b19fef595b6c58376c-3"></a>        http http://IP:9001/v2/zones/ZONE_ID/recordsets <span class="nv">name</span><span class="o">=</span>ww$i.largetestzone.tld. records:<span class="o">=</span><span class="s1">'["10.0.0.1"]'</span> <span class="nv">type</span><span class="o">=</span>A
<a name="rest_code_e72fa307033546b19fef595b6c58376c-4"></a>        http http://IP:9001/v2/zones/ZONE_ID/recordsets <span class="nv">name</span><span class="o">=</span>txt$i.largetestzone.tld. records:<span class="o">=</span><span class="s1">'["Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aliquam molestie leo sit amet commodo aliquet. Sed semper felis sit amet egestas euismod. Nulla non elementum orci. Nulla pharetra, ligula eget aliquet sagittis, velit nisl rhoncus nibh, vitae amet.", "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aliquam molestie leo sit amet commodo aliquet. Sed semper felis sit amet egestas euismod. Nulla non elementum orci. Nulla pharetra, ligula eget aliquet sagittis, velit nisl rhoncus nibh, vitae amet.", "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aliquam molestie leo sit amet commodo aliquet. Sed semper felis sit amet egestas euismod. Nulla non elementum orci. Nulla pharetra, ligula eget aliquet sagittis, velit nisl rhoncus nibh, vitae amet.", "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aliquam molestie leo sit amet commodo aliquet. Sed semper felis sit amet egestas euismod. Nulla non elementum orci. Nulla pharetra, ligula eget aliquet sagittis, velit nisl rhoncus nibh, vitae amet."]'</span> <span class="nv">type</span><span class="o">=</span>TXT
<a name="rest_code_e72fa307033546b19fef595b6c58376c-5"></a>    <span class="k">done</span>
</pre>
<p>Then from Dublin I started to run to see what was happening.</p>
<p><code class="bash">dig @IP -p <span class="m">5354</span> largetestzone.tld. AXFR</code></p>
<pre class="code bash"><a name="rest_code_a06b4c3038b34ad2b24b2894e49be21b-1"></a>dig @IP -p <span class="m">5354</span> largetestzone.tld. AXFR
</pre>
<p>What was interesting was that I had to get to 3 TCP messages before I started to see any issues,
and that those issues did not appear when I was testing from the same geographical region.</p>
<div class="section" id="what-did-we-learn">
<h2>What did we learn</h2>
<ul class="simple">
<li>Network stuff is hard.</li>
<li>Eventlet <em>will</em> change api's.</li>
<li>Read Eventlet Release Notes</li>
</ul>
<p>I think that we can start looking for ways to test this in the gate as well. having a gate check that loads
a large zone, adds latency + packet loss to fake a long range connection, and then ensures we
get a proper result from an API query would definitly catch real world errors like this.</p>
<p>If anyone wants to implement this, just hop in to <a class="reference external" href="irc://irc.freenode.net/openstack-dns">#openstack-dns</a>  on freenode :)</p>
<p>Patches are definitly welcome.</p>
</div>
<div class="section" id="other-bugs-found">
<h2>Other Bugs Found</h2>
<p>So, in the testing of this fix - we found a new bug. I am sure it will be the focus of a new blog (whenever we track it down)
but, it seems a large amount of traffic can cause eventlets <code class="python"><span class="n">socket</span><span class="o">.</span><span class="n">sendall</span><span class="p">()</span></code> to explode, and not send the complete traffic.</p>
<p><a class="reference external" href="../../listings/eventlet-sendall-bug-logs.log.html">eventlet-sendall-bug-logs.log</a></p>
<pre class="literal-block">
[-] Handling TCP Request from: MY_IP:50401 from (pid=60592) _dns_handle_tcp /home/graham/designate/designate/service.py:250
Policy check succeeded for rule 'all_tenants' on target {}
Unhandled exception while processing request from MY_IP:50401
 Traceback (most recent call last):
   File "/home/graham/designate/designate/service.py", line 342, in _dns_handle
     client.sendall(tcp_response)
   File "&lt;eventlet_path&gt;/eventlet/greenio/base.py", line 388, in sendall
     tail += self.send(data[tail:], flags)
   File "&lt;eventlet_path&gt;/eventlet/greenio/base.py", line 379, in send
     return self._send_loop(self.fd.send, data, flags)
   File "&lt;eventlet_path&gt;/eventlet/greenio/base.py", line 374, in _send_loop
     timeout_exc=socket.timeout("timed out"))
   File "&lt;eventlet_path&gt;/eventlet/greenio/base.py", line 203, in _trampoline
     mark_as_closed=self._mark_as_closed)
   File "&lt;eventlet_path&gt;/eventlet/hubs/__init__.py", line 162, in trampoline
     return hub.switch()
   File "&lt;eventlet_path&gt;/eventlet/hubs/hub.py", line 294, in switch
     return self.greenlet.switch()
 timeout: timed out


</pre>
<p>We decided that as all of the DNS servers we support will retry, and designate has retry semantics for updates, we should be
OK merging this fix, and finding the new bugs root cause in the near future.</p>
</div>
</div>
        </div>
                <ul class="pager hidden-print">
<li class="previous">
                <a href="../designate-mid-cycle/" rel="prev" title="Designate Mid Cycle">Previous post</a>
            </li>
        </ul>
<div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="grahamhayesie",
            disqus_url="http://graham.hayes.ie/posts/minidns-tcp-and-the-internet/",
        disqus_title="MiniDNS, TCP, and the internet",
        disqus_identifier="cache/posts/minidns-tcp-and-the-internet.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        
    </div>
                    <footer id="footer"><p>Contents © 2016         <a href="mailto:graham@hayes.ie">Graham Hayes</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         </p>
            
        </footer>
</div>
    </section><script src="../../assets/js/all-nocdn.js" type="text/javascript"></script><script type="text/javascript">
            $(function(){
                $('.timeago').timeago();
            });
        </script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-23042579-7', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
